<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Mapa de Postes</title>

    <!-- Evitar cache para não reusar página após logout -->
    <meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate, max-age=0">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">

    <!-- Guard de REFRESH: se for reload (F5/Ctrl+R), faz logout e volta para o login -->
    <script>
      (function () {
        try {
          var navEntries = (performance.getEntriesByType && performance.getEntriesByType('navigation')) || [];
          var nav = navEntries[0];
          var isReload = nav ? nav.type === 'reload'
                             : (performance && performance.navigation ? performance.navigation.type === 1 : false);

          if (isReload) {
            // tenta encerrar a sessão no backend (se existir) e volta para o login
            fetch("/api/auth/logout", { method: "POST", credentials: "include", cache: "no-store" })
              .catch(function(){ /* ignora se offline */ })
              .finally(function(){
                try {
                  localStorage.removeItem("auth_user");
                  sessionStorage.removeItem("auth_token");
                  document.cookie = "auth_token=; Max-Age=0; Path=/; SameSite=Lax";
                } catch(_) {}
                location.replace("/login.html");
              });
          }
        } catch (e) { /* silencioso */ }
      })();
    </script>

    <!-- Guard de login (CLIENTE): se não houver auth_user, manda pro login -->
    <script>
      (function () {
        try {
          const u = localStorage.getItem('auth_user');
          if (!u) location.replace('/login.html');
        } catch (_) {
          location.replace('/login.html');
        }
      })();
    </script>

    <!-- Favicon -->
    <link rel="icon" href="https://cdn.glitch.global/f333e829-c383-4385-9e81-43a47d865216/ChatGPT%20Image%2019%20de%20jun.%20de%202025%2C%2021_12_44.png?v=1750378383582" type="image/png" sizes="64x64"/>

    <!-- Leaflet & MarkerCluster -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css" />

    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />

    <style>
      :root{
        --ui-bg:#0f1b2a; --ui-elev:#132235; --ui-text:#e6edf7; --ui-muted:#9fb3c8;
        --ui-border:#19d68f; --ui-border-dim:#0d7b55; --ui-accent:#18c77f; --ui-accent-2:#0fb171; --ui-danger:#ef4444;
        --shadow:0 10px 28px rgba(0,0,0,.28); --dock-w:340px;
      }

      html, body { margin:0; padding:0; height:100%; background:#0b1624; }
      #map { width:100%; height:100%; position:relative; z-index:0; }
      #carregando[style*="display: none"] { pointer-events:none !important; }

      .painel-busca {
        position: fixed; top: 0; right: 0; height: 100vh; width: var(--dock-w); overflow: auto;
        background: var(--ui-bg); color: var(--ui-text);
        border-left: 2px solid var(--ui-border);
        padding: 16px 14px 18px; box-shadow: var(--shadow);
        font-family: "Segoe UI", system-ui, -apple-system, Roboto, Arial, sans-serif; z-index: 1000;
        transform: translateX(0%); transition: transform .25s ease;
      }
      .painel-busca.collapsed{ transform: translateX(100%); }
      .painel-busca h3 { margin: 6px 0 12px; font-weight: 800; color: var(--ui-text); letter-spacing:.3px; font-size: 16px; text-transform: uppercase; }
      .painel-busca .field { position: relative; margin-bottom: 10px; }
      .painel-busca .field input, .painel-busca .field textarea {
        width: 100%; padding: 10px 36px 10px 12px; background: var(--ui-elev); color: var(--ui-text);
        border: 1px solid var(--ui-border); border-radius: 10px; font-size: 14px; box-sizing: border-box;
        transition: border-color .15s ease, box-shadow .15s ease;
      }
      .painel-busca .field input::placeholder, .painel-busca .field textarea::placeholder { color: #8fb0c7; }
      .painel-busca .field input:focus, .painel-busca .field textarea:focus { outline: none; border-color: var(--ui-accent); box-shadow: 0 0 0 3px rgba(24,199,127,.22); }
      .painel-busca .field .fa { position: absolute; right: 10px; top: 50%; transform: translateY(-50%); color: var(--ui-muted); font-size: 14px; pointer-events:none; }

      .painel-busca .actions { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-top: 6px; }
      .painel-busca .actions button {
        display: flex; align-items: center; justify-content: center; padding: 10px 0;
        background: var(--ui-accent); color: #07251a; border: 1px solid var(--ui-border); border-radius: 10px;
        font-weight: 800; font-size: 13.5px; cursor: pointer;
        transition: transform .12s ease, background .15s ease, border-color .15s ease, box-shadow .15s ease;
        box-shadow: 0 1px 2px rgba(0,0,0,.18);
      }
      .painel-busca .actions button:hover { background: var(--ui-accent-2); border-color: var(--ui-accent); transform: translateY(-1px); }
      .painel-busca .actions button:active { transform: translateY(1px) scale(.98); }
      .painel-busca .actions button .fa { margin-right: 6px; }

      .legenda {
        position: absolute; bottom: 20px; right: 20px; background: rgba(15, 27, 42, 0.92); color: var(--ui-text);
        padding: 12px 14px; border-radius: 12px; border: 1px solid var(--ui-border);
        font-family: "Segoe UI", system-ui, -apple-system, Roboto, Arial, sans-serif; font-size: 13px; box-shadow: var(--shadow); z-index: 900;
      }
      .legenda-item { display: flex; align-items: center; margin-bottom: 6px; }
      .legenda-item:last-child{ margin-bottom:0; }
      .legenda-item .bolinha { width: 12px; height: 12px; border-radius: 50%; margin-right: 8px; border: 1px solid var(--ui-border); }

      .botao-topo {
        position: fixed; right: calc(var(--dock-w) + 16px); width: 42px; height: 42px;
        background: var(--ui-bg); color: var(--ui-text); border: 1px solid var(--ui-border); border-radius: 12px;
        box-shadow: var(--shadow); display: flex; align-items: center; justify-content: center;
        cursor: pointer; transition: background .15s ease, transform .12s ease, box-shadow .15s ease; z-index: 1100;
      }
      .botao-topo:hover { background: #122236; transform: translateY(-1px); }
      .botao-topo i { color: var(--ui-accent); }

      #togglePainel{ top: 50%; transform: translateY(-50%); width: 44px; height: 64px; border-radius: 12px 0 0 12px; }
      body.sidebar-collapsed #togglePainel{ right: 16px; }
      #localizacaoUsuario { top: 20px; }
      #logoutBtn { top: 70px; }
      body.sidebar-collapsed #localizacaoUsuario, body.sidebar-collapsed #logoutBtn{ right: 16px; }

      /* HUD agora dentro da sidebar */
      #widget-clima{ margin-top: 12px; }

      .overlay-loading { position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(5, 12, 22, 0.70); display: flex; align-items: center; justify-content: center; flex-direction: column; z-index: 3000; }
      .spinner { border: 6px solid #0e2236; border-top: 6px solid var(--ui-accent); border-radius: 50%;
        width: 48px; height: 48px; animation: girar 1s linear infinite; box-shadow: inset 0 0 0 1px rgba(25,214,143,.15); }
      .texto-loading { margin-top: 12px; color: var(--ui-text); font-family: "Segoe UI", system-ui, -apple-system, Roboto, Arial, sans-serif; }
      @keyframes girar { 0% { transform: rotate(0); } 100% { transform: rotate(360deg); } }

      @media (max-width: 880px){
        :root{ --dock-w: 300px; }
        .painel-busca .actions{ grid-template-columns: repeat(2,1fr); }
      }
      @media (max-width: 560px){
        :root{ --dock-w: 86vw; }
        .painel-busca .actions{ grid-template-columns: 1fr 1fr; gap:10px; }
      }
      @media (prefers-reduced-motion: reduce){ *{ transition:none !important; animation:none !important; } }
    </style>
  </head>

  <body>
    <!-- Botões de topo -->
    <div id="togglePainel" class="botao-topo" title="Esconder/Mostrar painel"><i class="fa fa-sliders"></i></div>
    <div id="localizacaoUsuario" class="botao-topo" title="Minha localização"><i class="fa fa-location-dot"></i></div>
    <div id="logoutBtn" class="botao-topo" title="Logout"><i class="fa fa-sign-out-alt"></i></div>

    <!-- Painel de busca (sidebar) -->
    <div class="painel-busca" id="painelBusca">
      <h3>Buscar Postes</h3>

      <div class="field">
        <input type="text" id="busca-id" placeholder="ID do Poste…" />
        <i class="fa fa-hashtag"></i>
      </div>

      <div class="field">
        <input type="text" id="busca-coord" placeholder="Lat, Lon…" />
        <i class="fa fa-map-marker-alt"></i>
      </div>

      <div class="field">
        <input type="text" id="busca-municipio" placeholder="Município…" list="lista-municipios" />
        <i class="fa fa-city"></i>
      </div>
      <datalist id="lista-municipios"></datalist>

      <div class="field">
        <input type="text" id="busca-bairro" placeholder="Bairro…" list="lista-bairros" />
        <i class="fa fa-map-marker-alt"></i>
      </div>
      <datalist id="lista-bairros"></datalist>

      <div class="field">
        <input type="text" id="busca-logradouro" placeholder="Logradouro…" list="lista-logradouros" />
        <i class="fa fa-road"></i>
      </div>
      <datalist id="lista-logradouros"></datalist>

      <div class="field">
        <input type="text" id="busca-empresa" placeholder="Empresa…" list="lista-empresas" />
        <i class="fa fa-building"></i>
      </div>
      <datalist id="lista-empresas"></datalist>

      <div class="field">
        <textarea id="ids-multiplos" rows="2" placeholder="Vários IDs…"></textarea>
        <i class="fa fa-list"></i>
      </div>

      <div class="actions">
        <button onclick="buscarID()"><i class="fa fa-search"></i>Buscar</button>
        <button onclick="buscarCoordenada()"><i class="fa fa-map-marker-alt"></i>Coordenada</button>
        <button onclick="filtrarLocal()"><i class="fa fa-filter"></i>Filtrar</button>
        <button onclick="consultarIDsEmMassa()"><i class="fa fa-chart-line"></i>Análise de Projeto</button>
        <button onclick="resetarMapa()"><i class="fa fa-undo"></i>Resetar</button>
        <button onclick="gerarPDFComMapa()"><i class="fa fa-file-pdf"></i>PDF</button>
        <button id="btnGerarExcel"><i class="fa fa-file-excel"></i>Excel</button>
        <button id="btnCenso"><i class="fa fa-camera"></i>Censo</button>
      </div>

      <!-- HUD (agora AQUI, logo abaixo das funções) -->
      <div id="widget-clima" class="dock-hud">
        <div id="tempo"></div>
      </div>
    </div>

    <!-- Legenda -->
    <div class="legenda">
      <div class="legenda-item"><div class="bolinha" style="background: yellow"></div>Poste intermediário</div>
      <div class="legenda-item"><div class="bolinha" style="background: green"></div>Até 5 empresas</div>
      <div class="legenda-item"><div class="bolinha" style="background: red"></div>Mais de 5 empresas</div>
    </div>

    <!-- Mapa -->
    <div id="map"></div>

    <!-- Spinner de carregamento -->
    <div id="carregando" class="overlay-loading" style="display: flex">
      <div class="spinner"></div>
      <div class="texto-loading">Carregando postes…</div>
    </div>

    <!-- JS -->
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>

    <!-- App -->
    <script src="script.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://unpkg.com/leaflet-image/leaflet-image.js"></script>

    <!-- Logout (CLIENTE) -->
    <script>
      document.getElementById("logoutBtn").addEventListener("click", () => {
        try {
          localStorage.removeItem("auth_user");
          sessionStorage.removeItem("auth_token");
          document.cookie = "auth_token=; Max-Age=0; Path=/; SameSite=Lax";
        } catch(_) {}
        location.replace("/login.html");
      });
    </script>

    <!-- Excel automático após filtragem (mantido) -->
    <script>
      function gerarExcelCliente(filtroIds) {
        const dadosParaExcel = todosPostes
          .filter((p) => filtroIds.includes(p.id))
          .map((p) => ({
            "ID POSTE": p.id,
            Município: p.nome_municipio,
            Bairro: p.nome_bairro,
            Logradouro: p.nome_logradouro,
            Empresas: p.empresas.join(", "),
            Coordenadas: p.coordenadas,
          }));
        const ws = XLSX.utils.json_to_sheet(dadosParaExcel);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Filtro");
        XLSX.writeFile(wb, "relatorio_filtrado.xlsx");
      }

      const _origFiltrarLocal = filtrarLocal;
      filtrarLocal = function () {
        _origFiltrarLocal();
        const mun = document.getElementById("busca-municipio").value.trim().toLowerCase();
        const bai = document.getElementById("busca-bairro").value.trim().toLowerCase();
        const log = document.getElementById("busca-logradouro").value.trim().toLowerCase();
        const emp = document.getElementById("busca-empresa").value.trim().toLowerCase();

        const filtro = todosPostes.filter((p) =>
          (!mun || p.nome_municipio.toLowerCase() === mun) &&
          (!bai || p.nome_bairro.toLowerCase() === bai) &&
          (!log || p.nome_logradouro.toLowerCase() === log) &&
          (!emp || p.empresas.join(", ").toLowerCase().includes(emp))
        );

        if (filtro.length) {
          const ids = filtro.map((p) => p.id);
          gerarExcelCliente(ids);
        }
      };
    </script>
  </body>
</html>
