<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
    <title>Login</title>

    <!-- Favicon removido intencionalmente para evitar marcas -->

    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500&display=swap" rel="stylesheet" />
    <style>
      :root {
        --bg-overlay: rgba(0,0,0,.28);
        --card-bg: rgba(255,255,255,.92);
        --card-border: rgba(255,255,255,.35);
        --txt-1: #1f2937; /* slate-800 */
        --txt-2: #6b7280; /* slate-500 */
        --brand: #0ea5e9; /* sky-500 */
        --brand-600: #0284c7; /* sky-600 */
        --danger: #e11d48; /* rose-600 */
        --ok: #16a34a; /* green-600 */
        --shadow: 0 20px 45px rgba(2, 8, 23, .35);
      }

      * { box-sizing: border-box; margin: 0; padding: 0; }
      html, body { height: 100%; }
      body {
        font-family: "Roboto", system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
        min-height: 100vh;
        display: grid;
        place-items: center;
        position: relative;
        color: var(--txt-1);
        overflow: hidden;
        background: #0b1220;
      }

      /* Background image + animated gradient veil */
      .bg {
        position: fixed; inset: 0; z-index: 0;
        background: url("https://cdn.glitch.global/f333e829-c383-4385-9e81-43a47d865216/7668651-alta-voltagem-polo-e-linhas-de-transmissao-ao-por-do-sol-com-ceu-laranja-e-vermelho-e-nuvens-arquitetura-silhueta-eletricidade-piloes-durante-por-do-sol-energia-e-energia-conservacao-de-energia-gratis-f%20(1).jpeg?v=1750365689665") center/cover no-repeat;
        filter: contrast(1.05) saturate(1.05) brightness(.95);
      }
      .veil {
        position: fixed; inset: 0; z-index: 1;
        background: radial-gradient(1200px 800px at 70% 30%, rgba(14,165,233,.22), transparent 60%),
                    radial-gradient(900px 700px at 20% 70%, rgba(2,132,199,.18), transparent 60%),
                    linear-gradient(0deg, rgba(0,0,0,.4), rgba(0,0,0,.4));
        mix-blend-mode: screen;
        animation: floatVeil 18s ease-in-out infinite alternate;
      }
      .overlay { position: fixed; inset: 0; z-index: 2; background: var(--bg-overlay); }

      @keyframes floatVeil {
        from { transform: translateY(-1.5%) scale(1.01); }
        to   { transform: translateY(1.5%)  scale(1.02); }
      }

      /* Floating particles (subtle) */
      .particles { position: fixed; inset: 0; z-index: 3; pointer-events: none; }
      .dot {
        position: absolute; width: 3px; height: 3px; border-radius: 9999px;
        background: rgba(255,255,255,.7);
        filter: blur(.2px);
        animation: drift linear infinite;
        opacity: .75;
      }
      @keyframes drift {
        from { transform: translate3d(var(--x), 110vh, 0) scale(.9); }
        to   { transform: translate3d(calc(var(--x) + 6vw), -15vh, 0) scale(1.1); }
      }

      /* Card */
      .login-box {
        position: relative; z-index: 4; width: 360px; max-width: 92vw;
        padding: 40px 32px; border-radius: 16px;
        background: var(--card-bg);
        border: 1px solid var(--card-border);
        box-shadow: var(--shadow);
        backdrop-filter: blur(8px) saturate(1.05);
        transform-style: preserve-3d; /* tilt effect */
        animation: fadeUp .8s cubic-bezier(.2,.7,.2,1) both .15s;
      }
      @keyframes fadeUp {
        from { opacity: 0; transform: translate3d(0, 18px, 0) scale(.985); }
        to   { opacity: 1; transform: translate3d(0, 0, 0) scale(1); }
      }

      .login-box h2 { margin-bottom: 22px; font-weight: 400; color: var(--txt-1); letter-spacing: .2px; }

      .field { text-align: left; margin-bottom: 16px; position: relative; }
      .label { font-size: 13px; color: var(--txt-2); margin-bottom: 6px; display: block; }

      .input {
        width: 100%; padding: 12px 14px 12px 40px; /* espaço pro ícone */
        border: 1px solid #d1d5db; border-radius: 10px; font-size: 14px;
        transition: border-color .2s, box-shadow .2s, transform .08s ease;
        background: #fff;
      }
      .input:focus {
        border-color: var(--brand); box-shadow: 0 0 0 4px rgba(14,165,233,.18); outline: none;
        transform: translateY(-1px);
      }
      .icon-input {
        position: absolute; left: 12px; top: 36px; width: 18px; height: 18px; opacity: .6;
      }

      .toggle-pass {
        position: absolute; right: 8px; top: 32px;
        border: none; background: transparent; cursor: pointer;
        font-size: 12px; color: var(--brand); padding: 6px; line-height: 1;
      }

      .hint { font-size: 12px; color: var(--txt-2); margin-top: 6px; }
      .caps { display: none; color: #b45309; font-size: 12px; margin-top: 6px; }

      /* Custom checkbox */
      .check-line { display: flex; align-items: center; gap: 10px; margin: 12px 0 18px; }
      .cbx { appearance: none; width: 18px; height: 18px; border: 1.5px solid #d1d5db; border-radius: 5px; display: grid; place-items: center; cursor: pointer; background: #fff; transition: border-color .2s, background .2s; }
      .cbx:checked { background: var(--brand); border-color: var(--brand); }
      .cbx:checked::after { content: ""; width: 10px; height: 10px; clip-path: polygon(14% 44%, 0 65%, 42% 100%, 100% 22%, 84% 0, 40% 71%); background: #fff; }

      .login-box a { color: var(--brand); text-decoration: none; }
      .login-box a:hover { text-decoration: underline; }

      /* Button with progress */
      .btn { width: 100%; padding: 12px; border: none; border-radius: 12px; font-size: 16px; font-weight: 600; color: #fff; cursor: pointer; background: linear-gradient(135deg, var(--brand), var(--brand-600)); box-shadow: 0 10px 30px rgba(2,132,199,.28); transition: transform .06s ease, filter .2s ease; }
      .btn:hover { filter: brightness(1.05); }
      .btn:active { transform: translateY(1px); }
      .btn:disabled { background: #9ca3af; box-shadow: none; cursor: not-allowed; }
      .btn.loading { position: relative; color: transparent; }
      .btn.loading::after { content: ""; position: absolute; inset: 0; margin: auto; width: 18px; height: 18px; border: 2px solid rgba(255,255,255,.7); border-right-color: transparent; border-radius: 50%; animation: spin .8s linear infinite; }
      @keyframes spin { to { transform: rotate(360deg); } }

      #error { margin-top: 12px; font-size: 14px; color: var(--danger); display: none; }
      #loading { margin-top: 10px; font-size: 13px; color: var(--txt-2); display: none; }

      .links { margin-top: 16px; font-size: 14px; }

      .footer-text { position: fixed; bottom: 0; left: 0; width: 100%; background: rgba(0,0,0,.75); color: #fff; text-align: center; padding: 8px 0; font-size: 12px; z-index: 5; }

      /* Reduced motion */
      @media (prefers-reduced-motion: reduce) {
        .veil, .login-box { animation: none !important; }
      }
    </style>
  </head>
  <body>
    <div class="bg" aria-hidden="true"></div>
    <div class="veil" aria-hidden="true"></div>
    <div class="overlay" aria-hidden="true"></div>
    <div class="particles" id="particles" aria-hidden="true"></div>

    <div class="login-box" role="main" aria-labelledby="loginTitle">
      <h2 id="loginTitle">Entrar</h2>

      <form id="loginForm" autocomplete="off" autocapitalize="none" spellcheck="false" novalidate>
        <div class="field">
          <label class="label" for="username">Usuário</label>
          <svg class="icon-input" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" xmlns="http://www.w3.org/2000/svg" aria-hidden="true"><path d="M20 21a8 8 0 10-16 0" stroke-linecap="round"/><circle cx="12" cy="7.5" r="3.5"/></svg>
          <input id="username" name="username" class="input" type="text" placeholder="seu.usuario@empresa" required inputmode="email" autocomplete="username" autocapitalize="none" />
          <div class="hint">Use seu usuário cadastrado</div>
        </div>

        <div class="field">
          <label class="label" for="password">Senha</label>
          <svg class="icon-input" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" xmlns="http://www.w3.org/2000/svg" aria-hidden="true"><rect x="3" y="10" width="18" height="11" rx="2"/><path d="M7 10V7a5 5 0 0110 0v3"/></svg>
          <input id="password" name="password" class="input" type="password" placeholder="••••••••" required autocomplete="current-password" />
          <button type="button" id="togglePass" class="toggle-pass" aria-label="Mostrar/ocultar senha">mostrar</button>
          <div id="capsHint" class="caps">Caps Lock ativo</div>
        </div>

        <div class="check-line">
          <input type="checkbox" id="lgpdCheck" class="cbx" />
          <label for="lgpdCheck" style="font-size:14px; color:var(--txt-1)">Aceito a <a href="/lgpd/privacy.html" target="_blank" rel="noopener">Política de Privacidade</a></label>
        </div>

        <button type="submit" id="btnLogin" class="btn" disabled>Login</button>
      </form>

      <div id="error" role="alert">Credenciais inválidas</div>
      <div id="loading" aria-live="polite">Validando…</div>

      <div class="links" aria-live="polite"></div>
    </div>

    <div class="footer-text">
      Desenvolvido por Caio Henrique Faria Gouveia — 2025
    </div>

    <script>
      // >>> Ajuste aqui o destino do mapa <<<
      const REDIRECT_URL = "/index.html"; // ex: "/mapa.html" ou "/postes.html"

      const form = document.getElementById("loginForm");
      const btnLogin = document.getElementById("btnLogin");
      const lgpdCheck = document.getElementById("lgpdCheck");
      const errorDiv = document.getElementById("error");
      const loadingTxt = document.getElementById("loading");
      const pass = document.getElementById("password");
      const user = document.getElementById("username");
      const togglePass = document.getElementById("togglePass");
      const capsHint = document.getElementById("capsHint");

      // Particles (lightweight)
      (function spawnParticles(){
        const wrap = document.getElementById('particles');
        const n = 22;
        for(let i=0;i<n;i++){
          const d = document.createElement('span');
          d.className = 'dot';
          const x = Math.random()*100; // vw
          const dur = 18 + Math.random()*16;
          d.style.setProperty('--x', x+'vw');
          d.style.left = x+'vw';
          d.style.animationDuration = dur+'s';
          d.style.animationDelay = (-Math.random()*dur)+'s';
          wrap.appendChild(d);
        }
      })();

      // Tilt effect (disabled on touch)
      (function tiltCard(){
        const box = document.querySelector('.login-box');
        if(!box) return;
        let supportsTouch = 'ontouchstart' in window || navigator.maxTouchPoints>0;
        if(supportsTouch) return;
        const max = 8; // deg
        function map(n, in_min, in_max, out_min, out_max) {
          return (n - in_min) * (out_max - out_min) / (in_max - in_min) + out_min;
        }
        window.addEventListener('mousemove', (e)=>{
          const r = box.getBoundingClientRect();
          const cx = r.left + r.width/2;
          const cy = r.top + r.height/2;
          const dx = e.clientX - cx;
          const dy = e.clientY - cy;
          const rx = map(dy, -r.height/2, r.height/2, max, -max);
          const ry = map(dx, -r.width/2,  r.width/2, -max, max);
          box.style.transform = `rotateX(${rx}deg) rotateY(${ry}deg)`;
        });
        window.addEventListener('mouseleave', ()=>{
          box.style.transform = 'rotateX(0) rotateY(0)';
        });
      })();

      // Se já tem usuário salvo, pula a tela
      (function autoSkipIfLogged() {
        try {
          const u = localStorage.getItem("auth_user");
          if (u) {
            window.location.replace(REDIRECT_URL);
          }
        } catch (_) {}
      })();

      // Limpa possíveis "fantasmas" de login armazenados localmente
      (function forceFreshLogin() {
        try {
          localStorage.removeItem("auth_user");
          sessionStorage.removeItem("auth_token");
          document.cookie = "auth_token=; Max-Age=0; Path=/; SameSite=Lax";
        } catch (_) {}
        if (pass) {
          pass.value = "";
          pass.setAttribute("autocomplete", "new-password");
        }
        window.addEventListener("pageshow", () => form.reset());
      })();

      // Habilita botão somente com LGPD
      lgpdCheck.addEventListener("change", () => {
        btnLogin.disabled = !lgpdCheck.checked;
      });

      // Mostrar/ocultar senha
      togglePass.addEventListener("click", () => {
        const isPwd = pass.getAttribute("type") === "password";
        pass.setAttribute("type", isPwd ? "text" : "password");
        togglePass.textContent = isPwd ? "ocultar" : "mostrar";
        pass.focus({ preventScroll: true });
      });

      // Aviso de Caps Lock
      function handleCaps(e) {
        const caps = e.getModifierState && e.getModifierState("CapsLock");
        capsHint.style.display = caps ? "block" : "none";
      }
      pass.addEventListener("keydown", handleCaps);
      pass.addEventListener("keyup", handleCaps);

      // Evita enter automático sem LGPD
      form.addEventListener("keydown", (e) => {
        if (e.key === "Enter" && !lgpdCheck.checked) e.preventDefault();
      });

      // Submit
      form.addEventListener("submit", async (e) => {
        e.preventDefault();
        errorDiv.style.display = "none";

        const username = user.value.trim();
        const password = pass.value;
        if (!username || !password) {
          errorDiv.textContent = "Informe usuário e senha.";
          errorDiv.style.display = "block";
          return;
        }
        if (!lgpdCheck.checked) {
          errorDiv.textContent = "Você precisa aceitar a Política de Privacidade.";
          errorDiv.style.display = "block";
          return;
        }

        // Bloqueia reenvio + spinner no botão
        btnLogin.disabled = true;
        btnLogin.classList.add('loading');
        loadingTxt.style.display = "block";

        try {
          const res = await fetch("/api/auth/login", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ username, password })
          });

          const data = await res.json().catch(() => ({}));

          if (res.ok && data && data.user) {
            try { localStorage.setItem("auth_user", JSON.stringify(data.user)); } catch (_){ }
            window.location.replace(REDIRECT_URL);
            return;
          }

          // Trata erros comuns
          if (res.status === 401) {
            errorDiv.textContent = "Credenciais inválidas";
          } else if (res.status === 400) {
            errorDiv.textContent = data.error || "Dados inválidos";
          } else if (res.status === 405) {
            errorDiv.textContent = "Método não permitido (a rota deve aceitar POST).";
          } else {
            errorDiv.textContent = data.error || `Erro ${res.status}`;
          }
          errorDiv.style.display = "block";
        } catch (err) {
          errorDiv.textContent = "Falha de rede. Verifique sua conexão e tente novamente.";
          errorDiv.style.display = "block";
        } finally {
          loadingTxt.style.display = "none";
          btnLogin.classList.remove('loading');
          btnLogin.disabled = !lgpdCheck.checked;
        }
      });
    </script>
  </body>
</html>
